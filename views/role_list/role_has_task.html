{{extend 'layout.html'}}
{{block header}}
{{controller_name = 'Role has task'}}
{{function_name='Index'}}
{{end}}
{{block content}}
<!--begin::Content-->
<div class="content d-flex flex-column flex-column-fluid" id="kt_content">
	<div class="container-xxl" id="kt_content_container">

		<form action="{{=URL('role_list','role_has_task_submit')}}" method="post">
		<!--begin::Card-->
		<div class="card role-card">

			<!--begin::Card body-->
			<div class="card-body py-3 role-page role-scroll">


					<!-- =========================
               ROLE INFO (TOP BAR)
          ========================== -->
					<div class="row g-3 mb-3">

						<div class="col-md-3">
							<label class="form-label fs-7 fw-semibold text-gray-600 mb-1">SBU</label>
							<input type="text" class="form-control form-control-sm form-control-solid" name="cid"
								value="{{=roles.cid}}" readonly>
						</div>

						<div class="col-md-4">
							<label class="form-label fs-7 fw-semibold text-gray-600 mb-1">Project</label>
							<input type="text" class="form-control form-control-sm form-control-solid"  name="pid" 
								value="{{=roles.pid}}" readonly>
						</div>

						<div class="col-md-5">
							<label class="form-label fs-7 fw-semibold text-gray-600 mb-1">Role</label>
							<input type="text" class="form-control form-control-sm form-control-solid"  name="role_name" 
								value="{{=roles.role_name}}" readonly>
							<input type="hidden" name="role_id" value="{{=roles.id}}">
						</div>

					</div>

					<!-- =========================
               HEADER
          ========================== -->
					<div class="d-flex justify-content-between align-items-center my-6 flex-wrap">

						<span class="fw-bold text-gray-800 fs-6 me-3">Task Permissions</span>

						<div class="d-flex align-items-center gap-2 flex-wrap">

							<!-- Search input -->
							<input type="text" id="taskGroupFilter"
								class="form-control form-control-sm"
								placeholder="Filter by group or task..."
								style="width:200px; height:32px;">

							<!-- Select all -->
							<div class="form-check form-check-sm ms-2">
							<input class="form-check-input form-check-input-sm" type="checkbox" id="checkAllTasks">
							<label class="form-check-label fw-bold ms-0" for="checkAllTasks">Select All</label>
							</div>

						</div>

						</div>


					<!-- =========================
               TASK GRID (4–4–4)
          ========================== -->
					<div class="row g-3">

						{{for groups in fin_task_list:}}
						<div class="col-md-4">

							<div class="task-group-box compact">

								<!-- Group Header -->
								<div class="group-header form-check form-check-sm">
									<span class="group-title">
										{{=groups['group_name']}}
									</span>

									<input class="form-check-input form-check-input-sm group-check" type="checkbox"
										data-group="{{=groups['group_name'].replace(' ','_')}}" id="checkgrpTasks">
								</div>

								<!-- Tasks -->
								<table class="table table-sm task-table mb-0">
									<tbody>

										{{for task in groups['task_list']:}}
										<tr class="task-row clickable" onclick="toggleTaskCheckbox(this)">

											<td class="task-check pe-0 me-0">
												<div class="form-check form-check-sm">
													<input class="form-check-input form-check-input-sm task-checkbox group-{{=groups['group_name'].replace(' ','_')}}" type="checkbox" name="task_ids[]"
														value="{{=task['task_id']}}||{{=task['task_name']}}" {{if str(task['task_id']) in role_task_list:}}checked{{pass}}>
												</div>
											</td>

											<td class="task-name">
												{{=task['task_name']}}
											</td>

										</tr>
										{{pass}}

									</tbody>
								</table>


							</div>

						</div>

						{{pass}}

					</div>

				

			</div>
			<!--end::Card body-->

			<!-- =========================
           STICKY ACTION BAR
      ========================== -->
			<div class="role-action-bar">
				<div class="d-flex justify-content-end gap-3 px-4">
					<!--begin::Add user-->
							<button type="submit" class="btn btn-primary me-3">
				
								<span class="svg-icon svg-icon-2">
									<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
										<path opacity="0.3" d="M10 4H21C21.6 4 22 4.4 22 5V7H10V4Z" fill="currentColor"/>
										<path d="M10.4 3.60001L12 6H21C21.6 6 22 6.4 22 7V19C22 19.6 21.6 20 21 20H3C2.4 20 2 19.6 2 19V4C2 3.4 2.4 3 3 3H9.20001C9.70001 3 10.2 3.20001 10.4 3.60001ZM16 11.6L12.7 8.29999C12.3 7.89999 11.7 7.89999 11.3 8.29999L8 11.6H11V17C11 17.6 11.4 18 12 18C12.6 18 13 17.6 13 17V11.6H16Z" fill="currentColor"/>
										<path opacity="0.3" d="M11 11.6V17C11 17.6 11.4 18 12 18C12.6 18 13 17.6 13 17V11.6H11Z" fill="currentColor"/>
									</svg>
								</span>
								Update
							</button>
					

							<!--begin::Export-->
							<a href="{{=URL('role_list','index')}}" class="btn btn-light-primary">
									<!--begin::Svg Icon | path: icons/duotune/arrows/arr078.svg-->
									<span class="svg-icon svg-icon-2">
										<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
											<rect opacity="0.5" x="6" y="11" width="13" height="2" rx="1" fill="currentColor"/>
											<path d="M8.56569 11.4343L12.75 7.25C13.1642 6.83579 13.1642 6.16421 12.75 5.75C12.3358 5.33579 11.6642 5.33579 11.25 5.75L5.70711 11.2929C5.31658 11.6834 5.31658 12.3166 5.70711 12.7071L11.25 18.25C11.6642 18.6642 12.3358 18.6642 12.75 18.25C13.1642 17.8358 13.1642 17.1642 12.75 16.75L8.56569 12.5657C8.25327 12.2533 8.25327 11.7467 8.56569 11.4343Z" fill="currentColor"/>
										</svg>
									</span>
									Back
							</a>
								<!--end::Svg Icon-->
				</div>
			</div>
		</div>
	</form>
		<!--end::Card-->

	</div>
</div>
<!--end::Content-->

<!-- =========================
     STYLES
========================== -->
<style>
	/* Card height control */
	.role-card {
		height: calc(100vh - 120px);
		display: flex;
		flex-direction: column;
	}

	/* Scroll only card body */
	.role-scroll {
		flex: 1;
		overflow-y: auto;
		padding-bottom: 16px;
	}

	/* Task group */
	.task-group-box {
		border: 1px solid #e4e6ef;
		border-radius: 6px;
		padding: 10px;
		background: #f9fafb;
	}

	.task-row:hover {
		background: #f1f5f9;
	}

	/* Sticky bottom bar */
	.role-action-bar {
		border-top: 1px solid #e4e6ef;
		background: #fff;
		padding: 10px 0;
	}

	/* Compact group box */
	.task-group-box.compact {
		border: 1px solid #e4e6ef;
		border-radius: 6px;
		padding: 8px 10px;
		background: #f9fafb;
	}

	/* Header */
	.group-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding-bottom: 4px;
		margin-bottom: 6px;
		border-bottom: 1px dashed #e5e7eb;
	}

	/* Group title */
	.group-title {
		font-size: 11px;
		font-weight: 600;
		color: #374151;
		text-transform: uppercase;
		letter-spacing: .3px;
	}

	/* Task table */
	.task-table td {
		vertical-align: middle;
	}

	/* Checkbox column */
	.task-check {
		width: 25px;
	}

	/* Task text */
	.task-name {
		font-size: 12px;
		color: #4b5563;
		padding-left: 4px;
	}

	/* Hover effect */
	.task-row:hover {
		background-color: #d5e0eb;
	}

	/* Smaller checkbox */
	.form-check-input-sm {
		width: 18px;
		height: 18px;
		margin-top: 0px;
	}

	/* Cursor + hover */
	.task-row.clickable {
		cursor: pointer;
	}

	.task-row.clickable:hover {
		background-color: #eef2ff;
	}

	/* Prevent double toggle when clicking checkbox itself */
	.task-row.clickable input {
		pointer-events: none;
	}
</style>



{{end}}


{{block script}}


<!-- =========================
     CHECK ALL SCRIPT
========================== -->
<script>
	document.addEventListener('DOMContentLoaded', function () {

		// Global select all
		document.getElementById('checkAllTasks').addEventListener('change', function () {
			document.querySelectorAll('.task-checkbox, .group-check')
				.forEach(cb => cb.checked = this.checked);
		});

		// Group select
		document.querySelectorAll('.group-check').forEach(groupCheck => {
			groupCheck.addEventListener('change', function () {
				document.querySelectorAll('.group-' + this.dataset.group)
					.forEach(cb => cb.checked = this.checked);
			});
		});

	});


	function toggleTaskCheckbox(row) {
		const checkbox = row.querySelector('input[type="checkbox"]');
		checkbox.checked = !checkbox.checked;
	}
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {

  const filterInput = document.getElementById('taskGroupFilter');

  filterInput.addEventListener('input', function () {
    const filter = this.value.toLowerCase();

    document.querySelectorAll('.task-group-box').forEach(function(groupBox) {
      const groupName = groupBox.querySelector('.group-title').textContent.toLowerCase();
      let matchGroup = groupName.includes(filter);
      let matchTask = false;

      // check tasks in this group
      groupBox.querySelectorAll('.task-row').forEach(function(taskRow) {
        const taskName = taskRow.querySelector('.task-name').textContent.toLowerCase();

        if(matchGroup) {
          // if group matches, show all tasks
          taskRow.style.display = '';
          matchTask = true;
        } else if(taskName.includes(filter)) {
          // if task matches, show it
          taskRow.style.display = '';
          matchTask = true;
        } else {
          // task does not match
          taskRow.style.display = 'none';
        }
      });

      // show/hide group based on match
      groupBox.style.display = (matchGroup || matchTask) ? '' : 'none';
    });

  });

});
</script>



{{end}}